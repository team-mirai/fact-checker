import OpenAI from "openai";

const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });
const vectorStoreId =
	process.env.VECTOR_STORE_ID ??
	(() => {
		throw new Error("VECTOR_STORE_ID is not set");
	})();

export interface CheckResult {
	ok: boolean; // äº‹å®Ÿã¨æ¦‚ã­ä¸€è‡´?
	answer: string; // GPT ãŒç”Ÿæˆã—ãŸå…¨æ–‡ (OK / NG + è©³ç´° & å‡ºå…¸)
	citations: string[]; // å‡ºå…¸ã ã‘ã‚’é…åˆ—ã§ä¿æŒ
}

/**
 * ãƒ•ã‚¡ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯æœ¬ä½“
 * @param statement ãƒã‚§ãƒƒã‚¯å¯¾è±¡æ–‡ç« 
 */
export async function factCheck(statement: string): Promise<CheckResult> {
	const res = await openai.responses.create({
		model: "o3-mini",
		tools: [{ type: "file_search", vector_store_ids: [vectorStoreId] }],
		include: ["file_search_call.results"],
		input: [
			{
				type: "message",
				role: "system",
				content: `ã‚ãªãŸã¯ãƒ•ã‚¡ã‚¯ãƒˆãƒã‚§ãƒƒã‚«ãƒ¼ã§ã™ã€‚  
ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¨çªãåˆã‚ã›ã¦çœŸå½ã‚’åˆ¤å®šã—ã€ä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ç­”ãˆã¦ãã ã•ã„ã€‚

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â–¼ã‚¹ãƒ†ãƒƒãƒ— 0 : äº‹å‰ãƒ•ã‚£ãƒ«ã‚¿
  â¶ å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆãŒã€Œå®¢è¦³çš„ã§æ¤œè¨¼å¯èƒ½ãªäº‹å®Ÿå‘½é¡Œã€ã‹åˆ¤å®šã›ã‚ˆã€‚
    ãƒ»æ„Ÿæƒ³ï¼æ„è¦‹ï¼ä¾¡å€¤åˆ¤æ–­ã®ã¿ã€ã‚ã‚‹ã„ã¯ä¸€æ™‚çš„ãƒ»ä¸»è¦³çš„å½¢å®¹ã¯ãƒ•ã‚¡ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯å¯¾è±¡å¤–
    ãƒ»ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã«å¯¾å¿œé …ç›®ãŒã¾ã£ãŸãå­˜åœ¨ã—ãªã„å ´åˆã‚‚ãƒ•ã‚¡ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯å¯¾è±¡å¤–
		ãƒ»äººåã‚„åœ°åï½¤URLã‚„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç­‰ã®å›ºæœ‰åè©ã‚„ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¯ãƒ•ã‚¡ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯å¯¾è±¡å¤–
		ãƒ»å€‹äººã®çµŒæ­´ã‚‚ãƒ•ã‚¡ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯å¯¾è±¡å¤–
  â· å¯¾è±¡å¤–ãªã‚‰ OK ã¨ã ã‘å‡ºåŠ›ã—ã€ç†ç”±ã‚’ 1 è¡Œã§è£œè¶³ï¼ˆå‡ºå…¸ä¸è¦ï¼‰ã€‚çµ‚äº†ã€‚

â–¼ã‚¹ãƒ†ãƒƒãƒ— 1 : çœŸå½åˆ¤å®šï¼ˆã‚¹ãƒ†ãƒƒãƒ— 0 ã‚’é€šéã—ãŸå ´åˆã®ã¿ï¼‰
  â¶ ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã§è£ãŒå–ã‚Œã‚‹ã‹ç¢ºèªã—ã€æ¬¡ã®ä¸‰ã¤ã‹ã‚‰ä¸€ã¤ã‚’é¸ã‚“ã§å†’é ­ã«å‡ºåŠ›  
      OK  : ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¨å®Œå…¨ã«ä¸€è‡´  
      NG  : ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¨çŸ›ç›¾ï¼ˆèª¤ã‚ŠãŒã‚ã‚‹ï¼‰  
      OK : ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã«ååˆ†ãªæƒ…å ±ãŒãªãåˆ¤å®šä¸èƒ½
  â· ãã®ä¸‹ã«ã€åˆ¤å®šæ ¹æ‹ ã®çŸ­ã„èª¬æ˜  
  â¸ ã©ã®ç®‡æ‰€ã«è¼‰ã£ã¦ã„ã‚‹ã‹ï¼ˆç¯€ãƒ»ãƒšãƒ¼ã‚¸ç­‰ï¼‰ã‚’ç®‡æ¡æ›¸ã  
  â¹ æœ€å¾Œã«å‡ºå…¸ï¼ˆURL/æ–‡çŒ®åãªã©ï¼‰

â–¼ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¾‹
OK
- æ ¹æ‹ : â€¦
- è©²å½“ç®‡æ‰€: â€¦
- å‡ºå…¸: â€¦

NG
- èª¤ã‚Š: â€¦
- æ­£ã—ã„æƒ…å ±: â€¦
- å‡ºå…¸: â€¦

OK  â†ã‚¹ãƒ†ãƒƒãƒ— 0 ã§çµ‚äº†
å…¥åŠ›æ–‡ã¯ä¸»è¦³çš„æ„Ÿæƒ³ã§ã‚ã‚Šå®¢è¦³çš„äº‹å®Ÿã§ã¯ãªã„ãŸã‚ã€‚
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        `,
			},
			{
				role: "user",
				content: statement,
			},
		],
	});

	/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ å‡ºå…¸ã‚’æ•´å½¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
	const citationBlocks: string[] = [];

	for (const item of res.output ?? []) {
		if (item.type === "file_search_call" && item.results) {
			for (const r of item.results) {
				citationBlocks.push(
					`- **${r.filename ?? r.file_id}**\n  > ${r.text?.trim()}`,
				);
			}
		}
	}

	/* â‘  ã¾ãšæœ¬æ–‡ã ã‘ã‚’ãƒˆãƒªãƒ ã—ã¦ä¿æŒ */
	const body = res.output_text.trim();

	const ng = /^NG/i.test(body);
	const ok = !ng;

	/* â‘¢ è¡¨ç¤ºç”¨ã® answer ã¯å‡ºå…¸ã‚’åŠ ãˆã¦çµ„ã¿ç«‹ã¦ */
	const answer = citationBlocks.length
		? `${body}

---

<details>
<summary>ğŸ“š å‡ºå…¸</summary>

${citationBlocks.join("\n\n")}

</details>`
		: body;

	return { ok, answer, citations: citationBlocks };
}
